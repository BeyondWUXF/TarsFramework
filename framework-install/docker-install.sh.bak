#!/bin/sh
#docker 启动时执行

export PATH=/root/.nvm/versions/node/v12.13.0/bin/:$PATH
export npm=mirrors.cloud.tencent.com

env

workdir=$(cd $(dirname $0); pwd)

sh ${workdir}/tars.sh stop

cd ${workdir}/deploy

pwd

#python deploy.py deploy

TARS_PATH=/usr/local/app/tars

TARS=(tarsAdminRegistry tarsconfig  tarslog  tarsnode  tarsnotify  tarspatch  tarsproperty  tarsqueryproperty  tarsquerystat  tarsregistry  tarsstat)

for var in ${TARS[@]};
do
   if [ ! -d ${TARS_PATH}/${var} ]; then
       echo "${TARS_PATH}/${var} not exist."
       exit -1 
   fi
done

sh ${workdir}/tars.sh start

if [ "$1" == "check" ]; then
  echo "begin check server..."
  TARS=(tarsAdminRegistry  tarsnode  tarsregistry)

  while [ 1 ]
  do
  #  echo "check server..."

    for var in ${TARS[@]};
    do
      sh ${TARS_PATH}/${var}/util/check.sh
    done

    pid=`ps -ef | grep tars-node-web | grep -v grep | awk -F' ' '{print $2}'`
    if echo $pid | grep -q '[^0-9]'
    then
      echo "start tars-web"
      cd /usr/local/app/web/; nohup npm run start &
    fi

    sleep 3

  done
fi


